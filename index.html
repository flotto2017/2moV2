<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ครูเอฟ จินตคณิต - แอปฝึกคิดเลขเร็ว</title>

<!-- =======================
      STYLE SECTION (บล็อกที่ 2 จะถูกแทรกตรงนี้)
     ======================= -->
<style>
/* ========= RESET พื้นฐาน ========= */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #fef3c7; /* โทนเหลืองส้มอ่อน */
  color: #111827;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

/* ========= HEADER ========= */
.app-header {
  text-align: center;
  padding: 10px 8px 4px;
}

.app-header h2 {
  font-size: 1.4rem;
  font-weight: 800;
  color: #ea580c; /* ส้มเข้ม */
  text-shadow: 0 1px 2px rgba(248, 250, 252, 0.8);
}

/* ========= TOP MENU BAR ========= */
.menu-bar {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 6px 8px 4px;
  flex-wrap: wrap;
}

.menu-bar button {
  min-width: 70px;
  padding: 8px 10px;
  border-radius: 999px;
  border: none;
  background: #f97316;
  color: #fff;
  font-size: 0.8rem;
  font-weight: 600;
  box-shadow: 0 2px 5px rgba(249,115,22,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.menu-bar button:active {
  transform: translateY(1px) scale(0.97);
  box-shadow: 0 1px 3px rgba(249,115,22,0.6);
}

/* ========= DISPLAY BOX (ไม่ให้ขยับสูง-ต่ำ) ========= */
.display-box {
  margin: 6px auto 4px;
  width: 90%;
  max-width: 480px;
  border-radius: 16px;
  background: radial-gradient(circle at top, #fed7aa, #fff7ed);
  border: 1px solid rgba(248, 171, 95, 0.5);
  box-shadow: 0 6px 16px rgba(248,171,95,0.35);
  text-align: center;
  color: #111827;
  font-weight: 800;
  font-size: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;

  /* ความสูงคงที่ เพื่อไม่ให้เมนูเลื่อน */
  min-height: 120px;
  max-height: 140px;
  padding: 10px;
}

/* ขนาดตัวเลขจะถูก JS ปรับด้วย class หรือ style เพิ่มเติมภายหลังถ้าต้องการ */

/* ========= SETTINGS PANEL ========= */
.settings-panel {
  width: 90%;
  max-width: 480px;
  margin: 6px auto 0;
  background: #f9fafb;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.5);
  box-shadow: 0 4px 10px rgba(148,163,184,0.2);
  padding: 10px 12px 12px;
  font-size: 0.85rem;
}

.settings-panel h3 {
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: #374151;
}

.settings-panel label {
  display: block;
  margin-top: 6px;
  margin-bottom: 2px;
  font-weight: 600;
  color: #4b5563;
}

.settings-panel input[type="number"],
.settings-panel select {
  width: 100%;
  padding: 4px 6px;
  border-radius: 8px;
  border: 1px solid #cbd5f5;
  font-size: 0.85rem;
  background: #ffffff;
}

.settings-panel hr {
  border: none;
  border-top: 1px dashed rgba(148,163,184,0.6);
  margin: 10px 0 6px;
}

/* ========= ADMIN PANEL ========= */
#adminPanel h4 {
  margin-bottom: 6px;
  font-size: 0.9rem;
  color: #111827;
}

#adminPanel input {
  border-radius: 8px;
  border: 1px solid #cbd5f5;
  font-size: 0.8rem;
  background: #ffffff;
}

#adminUserList {
  font-size: 0.78rem;
}

#adminUserList div {
  border-bottom: 1px solid rgba(209,213,219,0.8);
}

#adminUserList div:last-child {
  border-bottom: none;
}

/* ========= KEYPAD / ANSWER AREA ========= */
.keypad-area {
  width: 90%;
  max-width: 480px;
  margin: 10px auto 14px;
  background: #f9fafb;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.5);
  box-shadow: 0 4px 10px rgba(148,163,184,0.25);
  padding: 10px 10px 12px;
}

.answer-input {
  width: 100%;
  padding: 6px 8px;
  border-radius: 10px;
  border: 2px solid #f97316;
  font-size: 1.8rem;
  text-align: center;
  margin-bottom: 8px;
  background: #ffffff;
}

/* keypad เป็น grid 3 คอลัมน์ ปุ่มสี่เหลี่ยมจัตุรัส */
.keypad {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
  margin-bottom: 8px;
}

.keypad button {
  width: 100%;
  aspect-ratio: 1 / 1;           /* ทำให้เป็นจัตุรัส */
  border-radius: 12px;
  border: none;
  background: #e5e7eb;
  box-shadow: 0 2px 4px rgba(107,114,128,0.6);
  font-size: 1.2rem;
  font-weight: 700;
  color: #111827;
  display: flex;
  align-items: center;
  justify-content: center;
}

.keypad button:active {
  transform: translateY(1px) scale(0.98);
  box-shadow: 0 1px 3px rgba(107,114,128,0.7);
}

/* ปุ่มควบคุมคำตอบ */
.key-enter,
.key-back,
.key-clear {
  width: 32%;
  border-radius: 999px;
  border: none;
  padding: 6px 0;
  font-size: 0.9rem;
  font-weight: 600;
  margin-right: 1.5%;
  color: #fff;
}

.key-enter {
  background: #16a34a;
}

.key-back {
  background: #f97316;
}

.key-clear {
  background: #dc2626;
}

.key-enter:active,
.key-back:active,
.key-clear:active {
  transform: translateY(1px) scale(0.97);
}

/* ========= RESPONSIVE ========= */
@media (min-width: 768px) {
  .display-box {
    max-width: 520px;
    min-height: 140px;
    max-height: 160px;
    font-size: 3.5rem;
  }

  .settings-panel,
  .keypad-area {
    max-width: 520px;
  }
}

</style>

</head>
<body>

<!-- =======================
      LOGIN OVERLAY
     ======================= -->
<div id="loginOverlay" style="
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999;
">
  <div style="
    width: 90%; max-width: 320px;
    background: white; padding: 20px;
    border-radius: 16px; text-align: center;
  ">
    <h3 style="margin: 0;">เข้าสู่ระบบ</h3>
    <p style="font-size: 0.85rem; color:#555; margin-top:4px;">
      ใส่ Username และ Password
    </p>

    <input id="loginUser"
           type="text"
           placeholder="Username"
           style="width: 90%; padding:8px; margin-top:10px;
                  border-radius:8px; border:1px solid #ccc;">

    <input id="loginPass"
           type="password"
           placeholder="Password"
           style="width: 90%; padding:8px; margin-top:8px;
                  border-radius:8px; border:1px solid #ccc;">

    <div id="loginError" style="color:red; font-size:0.8rem; min-height:1.2rem;"></div>

    <button id="loginBtn"
            style="padding:8px 20px; margin-top:10px;
                   border:none; border-radius:999px;
                   background:#f97316; color:white; font-weight:600;">
      เข้าสู่ระบบ
    </button>
  </div>
</div>

<!-- =======================
      APP HEADER
     ======================= -->
<div class="app-header">
  <h2>ครูเอฟ จินตคณิต</h2>
  <div id="currentUserBox" style="font-size:0.85rem; color:#333;"></div>
</div>

<!-- =======================
      TOP MENU BAR
     ======================= -->
<div class="menu-bar">
  <button id="btnSettings">ตั้งค่า</button>
  <button id="btnStart">เริ่ม</button>
  <button id="btnStop">หยุด</button>
  <button id="btnReset">รีเซ็ต</button>
  <button id="btnFullscreen">เต็มจอ</button>
</div>

<!-- =======================
      DISPLAY BOX
     ======================= -->
<div id="displayBox" class="display-box">พร้อม</div>

<!-- =======================
      SETTINGS PANEL
     ======================= -->
<div id="settingsPanel" class="settings-panel" style="display:none;">

  <h3>การตั้งค่า</h3>

  <label>จำนวนตัวเลขต่อ 1 ข้อ</label>
  <input id="setCountPerQuestion" type="number" min="1" max="99" value="5">

  <label>จำนวนข้อใน 1 รอบ</label>
  <input id="setTotalQuestions" type="number" min="1" max="99" value="10">

  <label>ความเร็วการแสดงตัวเลข (ms)</label>
  <input id="setSpeed" type="number" min="100" max="5000" value="800">

  <label>ขนาดตัวเลข</label>
  <select id="setFontSize">
    <option value="small">เล็ก</option>
    <option value="medium" selected>กลาง</option>
    <option value="large">ใหญ่</option>
    <option value="xl">XL</option>
    <option value="xxl">XXL</option>
  </select>

  <hr>

  <!-- ADMIN MODE BUTTON -->
  <button id="adminToggleBtn"
          style="background:#6b7280; color:white; border:none;
                 padding:6px 12px; border-radius:8px;">
    โหมดผู้ดูแล (Admin)
  </button>

  <!-- =======================
        ADMIN PANEL
       ======================= -->
  <div id="adminPanel" style="display:none; margin-top:10px; 
                              background:#f3f4f6; padding:12px; border-radius:10px;">

    <h4>จัดการบัญชีผู้ใช้</h4>

    <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:10px;">
      <input id="adminNewUser" type="text" placeholder="username"
             style="flex:1; padding:4px;">
      <input id="adminNewPass" type="text" placeholder="password"
             style="flex:1; padding:4px;">
      <input id="adminNewName" type="text" placeholder="ชื่อแสดง"
             style="flex:1; padding:4px;">
      <button id="adminAddUserBtn"
              style="padding:4px 10px; background:#22c55e; color:white;
                     border:none; border-radius:6px;">เพิ่ม</button>
    </div>

    <div style="margin-top:6px; font-weight:600;">รายชื่อผู้ใช้</div>
    <div id="adminUserList"
         style="max-height:150px; overflow:auto; background:white;
                border:1px solid #ddd; padding:6px; border-radius:8px;">
      (กำลังโหลด…)
    </div>

    <button id="adminResetAllBtn"
            style="margin-top:10px; padding:4px 10px; background:#ef4444; color:white;
                   border:none; border-radius:6px;">
      รีเซ็ตสถิติทั้งหมด
    </button>

  </div>

</div>

<!-- =======================
      CHALLENGE KEYPAD
     ======================= -->
<div id="keypadArea" class="keypad-area" style="display:none;">
  <input id="answerInput" type="text" readonly class="answer-input">

  <div class="keypad">
    <!-- ปุ่มตัวเลข จะถูกสร้างด้วย JS -->
  </div>

  <button id="keyEnter" class="key-enter">ENTER</button>
  <button id="keyBack" class="key-back">ลบ</button>
  <button id="keyClear" class="key-clear">ล้าง</button>
</div>

<!-- =======================
      SCRIPT
     ======================= -->
<script>
/********************************************
 *  บล็อกที่ 3 – JavaScript หลักของแอป
 *  - Login + Admin
 *  - โหมดฝึกฝน / ท้าทาย
 *  - สุ่มเลข / แสดงผล / เก็บสถิติ
 ********************************************/

// --------- คีย์สำหรับ localStorage ---------
const USERS_KEY          = "kruF_users_v1";
const CURRENT_USER_KEY   = "kruF_current_user_v1";
const SETTINGS_KEY       = "kruF_settings_v1";
const ADMIN_PASSWORD     = "KF888";      // รหัส admin ตามที่ครูระบุ

// --------- ตัวแปรผู้ใช้ / admin ---------
let users = [];          // {username, password, displayName}[]
let currentUser = null;
let isAdminMode = false;

// --------- ตัวแปรเกม ---------
let mode = "practice";          // "practice" หรือ "challenge"
let isRunning = false;

let numbersPerQuestion = 5;     // จำนวนตัวเลขต่อข้อ
let totalQuestions = 10;        // จำนวนข้อใน 1 รอบ
let speedMs = 800;              // ms แสดงตัวเลขแต่ละตัว
let fontSizeSetting = "medium"; // small/medium/large/xl/xxl

let currentQuestionIndex = 0;   // เริ่มจาก 1 ถึง totalQuestions
let currentSequence = [];
let currentAnswer = 0;
let currentIndexInSeq = 0;

let mainTimer = null;
let blinkTimer = null;

// challenge mode
let challengeCorrect = 0;
let challengeMistakes = 0;
let challengeTarget = 10;
let challengeStartTime = null;

// --------- อ้างอิง DOM ---------
const loginOverlay   = document.getElementById("loginOverlay");
const loginUserInput = document.getElementById("loginUser");
const loginPassInput = document.getElementById("loginPass");
const loginBtn       = document.getElementById("loginBtn");
const loginErrorBox  = document.getElementById("loginError");

const currentUserBox = document.getElementById("currentUserBox");

const btnSettings    = document.getElementById("btnSettings");
const btnStart       = document.getElementById("btnStart");
const btnStop        = document.getElementById("btnStop");
const btnReset       = document.getElementById("btnReset");
const btnFullscreen  = document.getElementById("btnFullscreen");

const displayBox     = document.getElementById("displayBox");
const settingsPanel  = document.getElementById("settingsPanel");

const setCountPerQuestion = document.getElementById("setCountPerQuestion");
const setTotalQuestions   = document.getElementById("setTotalQuestions");
const setSpeed            = document.getElementById("setSpeed");
const setFontSize         = document.getElementById("setFontSize");

const adminToggleBtn      = document.getElementById("adminToggleBtn");
const adminPanel          = document.getElementById("adminPanel");
const adminNewUser        = document.getElementById("adminNewUser");
const adminNewPass        = document.getElementById("adminNewPass");
const adminNewName        = document.getElementById("adminNewName");
const adminAddUserBtn     = document.getElementById("adminAddUserBtn");
const adminUserList       = document.getElementById("adminUserList");
const adminResetAllBtn    = document.getElementById("adminResetAllBtn");

const keypadArea          = document.getElementById("keypadArea");
const answerInput         = document.getElementById("answerInput");
const keypadDiv           = document.querySelector(".keypad");
const keyEnter            = document.getElementById("keyEnter");
const keyBack             = document.getElementById("keyBack");
const keyClear            = document.getElementById("keyClear");

// จะสร้าง selector โหมดการเล่นแบบ dynamic ใน settingsPanel
let modeSelect = null;

// --------- Audio (Beep เบา ๆ) ---------
let audioCtx = null;
function initAudio() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (AC) audioCtx = new AC();
  }
}
function playBeep(freq=900, duration=0.08) {
  try {
    initAudio();
    if (!audioCtx) return;
    const osc  = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.01);
    gain.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration + 0.03);
  } catch(e){}
}

// --------- ฟังก์ชันผู้ใช้ & Login ---------
function loadUsers() {
  const raw = localStorage.getItem(USERS_KEY);
  if (!raw) {
    // ยังไม่มี user เลย → สร้าง admin เริ่มต้น
    users = [{
      username: "admin",
      password: "KF888",
      displayName: "ผู้ดูแลระบบ"
    }];
    saveUsers();
    return;
  }
  try {
    const arr = JSON.parse(raw);
    if (Array.isArray(arr) && arr.length > 0) {
      users = arr;
    } else {
      users = [{
        username: "admin",
        password: "KF888",
        displayName: "ผู้ดูแลระบบ"
      }];
      saveUsers();
    }
  } catch(e) {
    users = [{
      username: "admin",
      password: "KF888",
      displayName: "ผู้ดูแลระบบ"
    }];
    saveUsers();
  }
}

function saveUsers() {
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

function updateCurrentUserBox() {
  if (!currentUser) {
    currentUserBox.innerHTML = `<span style="color:#ef4444;">ยังไม่ได้เข้าสู่ระบบ</span>`;
    return;
  }
  const u = users.find(x => x.username === currentUser);
  const displayName = u ? (u.displayName || u.username) : currentUser;
  currentUserBox.innerHTML = `
    ผู้เล่น: <b>${displayName}</b> (${currentUser})
    <button onclick="logoutUser()" 
            style="margin-left:6px; padding:2px 8px; border:none;
                   border-radius:999px; background:#ef4444; color:white;
                   font-size:0.75rem;">
      ออกจากระบบ
    </button>
  `;
}

function tryLogin() {
  const u = loginUserInput.value.trim();
  const p = loginPassInput.value.trim();
  loginErrorBox.textContent = "";

  if (!u || !p) {
    loginErrorBox.textContent = "กรุณากรอกให้ครบ";
    return;
  }
  const rec = users.find(x => x.username === u);
  if (!rec) {
    loginErrorBox.textContent = "ไม่พบ username นี้";
    return;
  }
  if (rec.password !== p) {
    loginErrorBox.textContent = "รหัสผ่านไม่ถูกต้อง";
    return;
  }

  currentUser = rec.username;
  localStorage.setItem(CURRENT_USER_KEY, currentUser);
  loginOverlay.style.display = "none";
  updateCurrentUserBox();
}

function logoutUser() {
  currentUser = null;
  localStorage.removeItem(CURRENT_USER_KEY);
  loginOverlay.style.display = "flex";
  updateCurrentUserBox();
  stopGame();
}

// ให้เรียกจาก HTML (ปุ่ม logout)
window.logoutUser = logoutUser;

// --------- Admin Mode ---------
function askAdminPassword() {
  const input = prompt("กรุณาใส่รหัสผ่านผู้ดูแล (Admin)");
  if (input === null) return false;
  if (input === ADMIN_PASSWORD) {
    alert("เข้าสู่โหมดผู้ดูแลแล้ว");
    return true;
  } else {
    alert("รหัสผ่านไม่ถูกต้อง");
    return false;
  }
}

function renderUserList() {
  adminUserList.innerHTML = "";
  if (!users.length) {
    adminUserList.textContent = "ยังไม่มีผู้ใช้";
    return;
  }

  users.forEach((u, i) => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.alignItems = "center";
    row.style.padding = "2px 0";

    // นับสถิติของ user นี้
    const practiceKey  = "practice_results_" + u.username;
    const challengeKey = "challenge_results_" + u.username;
    let pracCount = 0;
    let chalCount = 0;

    try {
      const pRaw = localStorage.getItem(practiceKey);
      if (pRaw) {
        const arr = JSON.parse(pRaw);
        if (Array.isArray(arr)) pracCount = arr.length;
      }
      const cRaw = localStorage.getItem(challengeKey);
      if (cRaw) {
        const arr2 = JSON.parse(cRaw);
        if (Array.isArray(arr2)) chalCount = arr2.length;
      }
    } catch(e){}

    const left = document.createElement("span");
    left.innerHTML = `${i+1}. <b>${u.displayName || u.username}</b> (${u.username})<br>
      ฝึกฝน: ${pracCount} รอบ | ท้าทาย: ${chalCount} รอบ`;

    const btns = document.createElement("span");

    const viewBtn = document.createElement("button");
    viewBtn.textContent = "ดูสถิติ";
    viewBtn.style.border = "none";
    viewBtn.style.borderRadius = "999px";
    viewBtn.style.background = "#3b82f6";
    viewBtn.style.color = "#fff";
    viewBtn.style.fontSize = "0.7rem";
    viewBtn.style.padding = "2px 6px";
    viewBtn.style.marginRight = "3px";
    viewBtn.onclick = () => showUserStats(u.username);

    const editBtn = document.createElement("button");
    editBtn.textContent = "แก้ไข";
    editBtn.style.border = "none";
    editBtn.style.borderRadius = "999px";
    editBtn.style.background = "#f59e0b";
    editBtn.style.color = "#fff";
    editBtn.style.fontSize = "0.7rem";
    editBtn.style.padding = "2px 6px";
    editBtn.style.marginRight = "3px";
    editBtn.onclick = () => editUser(u.username);

    const delBtn = document.createElement("button");
    delBtn.textContent = "ลบ";
    delBtn.style.border = "none";
    delBtn.style.borderRadius = "999px";
    delBtn.style.background = "#ef4444";
    delBtn.style.color = "#fff";
    delBtn.style.fontSize = "0.7rem";
    delBtn.style.padding = "2px 6px";
    delBtn.onclick = () => deleteUser(u.username);

    btns.appendChild(viewBtn);
    btns.appendChild(editBtn);
    if (u.username !== "admin") btns.appendChild(delBtn);

    row.appendChild(left);
    row.appendChild(btns);
    adminUserList.appendChild(row);
  });
}

function showUserStats(username) {
  const practiceKey  = "practice_results_" + username;
  const challengeKey = "challenge_results_" + username;

  let prac = [];
  let chal = [];
  try {
    const pRaw = localStorage.getItem(practiceKey);
    if (pRaw) {
      const arr = JSON.parse(pRaw);
      if (Array.isArray(arr)) prac = arr;
    }
    const cRaw = localStorage.getItem(challengeKey);
    if (cRaw) {
      const arr2 = JSON.parse(cRaw);
      if (Array.isArray(arr2)) chal = arr2;
    }
  } catch(e){}

  let msg = `สถิติของ ${username}\n\n[โหมดฝึกฝน] รอบทั้งหมด: ${prac.length}\n`;
  prac.slice(-5).forEach((r, idx) => {
    msg += `- รอบล่าสุด ${prac.length - (prac.slice(-5).length - idx) + 1}: `;
    msg += `ข้อ: ${r.totalQuestions}, ต่อข้อ: ${r.numbersPerQuestion}, ความเร็ว: ${r.speedMs}ms\n`;
  });

  msg += `\n[โหมดท้าทาย] รอบทั้งหมด: ${chal.length}\n`;
  chal.slice(-5).forEach((r, idx) => {
    msg += `- รอบล่าสุด ${chal.length - (chal.slice(-5).length - idx) + 1}: `;
    msg += `เวลา: ${r.time.toFixed(2)} วินาที, ผิด: ${r.mistakes}\n`;
  });

  alert(msg);
}

function editUser(username) {
  const u = users.find(x => x.username === username);
  if (!u) return;
  const newName = prompt("ชื่อแสดงใหม่:", u.displayName || u.username);
  if (newName === null) return;
  const newPass = prompt("รหัสผ่านใหม่:", u.password);
  if (newPass === null) return;
  u.displayName = newName.trim() || u.username;
  u.password    = newPass.trim() || u.password;
  saveUsers();
  renderUserList();
  if (currentUser === u.username) updateCurrentUserBox();
}

function deleteUser(username) {
  if (!confirm("ต้องการลบผู้ใช้ " + username + " ?")) return;
  users = users.filter(x => x.username !== username);
  saveUsers();

  // ลบสถิติของ user นี้ด้วย
  localStorage.removeItem("practice_results_" + username);
  localStorage.removeItem("challenge_results_" + username);

  if (currentUser === username) {
    logoutUser();
  } else {
    renderUserList();
  }
}

// admin เพิ่ม user
function addUserFromAdmin() {
  const uname = (adminNewUser.value || "").trim();
  const pass  = (adminNewPass.value || "").trim();
  const name  = (adminNewName.value || "").trim();

  if (!uname || !pass) {
    alert("ต้องกรอก username และ password");
    return;
  }
  if (users.find(x => x.username === uname)) {
    alert("มี username นี้แล้ว");
    return;
  }
  users.push({
    username: uname,
    password: pass,
    displayName: name || uname
  });
  saveUsers();
  adminNewUser.value = "";
  adminNewPass.value = "";
  adminNewName.value = "";
  renderUserList();
}

function resetAllStats() {
  if (!confirm("รีเซ็ตสถิติของผู้ใช้ทุกคนทั้งหมด?")) return;
  users.forEach(u => {
    localStorage.removeItem("practice_results_" + u.username);
    localStorage.removeItem("challenge_results_" + u.username);
  });
  alert("รีเซ็ตสถิติเรียบร้อย");
  renderUserList();
}

// --------- Settings (โหมด / จำนวน / ความเร็ว / ขนาดตัวเลข) ---------
function ensureModeSelector() {
  // สร้าง select เลือกโหมด ถ้ายังไม่มี
  if (!settingsPanel) return;
  if (document.getElementById("setMode")) {
    modeSelect = document.getElementById("setMode");
    return;
  }

  const h3 = settingsPanel.querySelector("h3");
  if (!h3) return;

  const wrapper = document.createElement("div");
  wrapper.innerHTML = `
    <label>โหมดการเล่น</label>
    <select id="setMode" style="width:100%; padding:4px 6px;
                                border-radius:8px; border:1px solid #cbd5f5;
                                font-size:0.85rem; background:#fff;">
      <option value="practice">ฝึกฝน (แสดงเฉลยอัตโนมัติ)</option>
      <option value="challenge">ท้าทาย (ตอบเองด้วยปุ่มตัวเลข)</option>
    </select>
  `;
  h3.insertAdjacentElement("afterend", wrapper);
  modeSelect = document.getElementById("setMode");
}

function loadSettings() {
  ensureModeSelector();
  const raw = localStorage.getItem(SETTINGS_KEY);
  if (!raw) {
    // defaults
    numbersPerQuestion = parseInt(setCountPerQuestion.value) || 5;
    totalQuestions     = parseInt(setTotalQuestions.value) || 10;
    speedMs            = parseInt(setSpeed.value) || 800;
    fontSizeSetting    = setFontSize.value || "medium";
    mode               = modeSelect ? modeSelect.value : "practice";
    applyFontSize();
    updateKeypadVisibility();
    return;
  }
  try {
    const s = JSON.parse(raw);
    if (s.numbersPerQuestion != null) {
      numbersPerQuestion = s.numbersPerQuestion;
      setCountPerQuestion.value = numbersPerQuestion;
    }
    if (s.totalQuestions != null) {
      totalQuestions = s.totalQuestions;
      setTotalQuestions.value = totalQuestions;
    }
    if (s.speedMs != null) {
      speedMs = s.speedMs;
      setSpeed.value = speedMs;
    }
    if (s.fontSizeSetting) {
      fontSizeSetting = s.fontSizeSetting;
      setFontSize.value = fontSizeSetting;
    }
    if (s.mode && modeSelect) {
      mode = s.mode;
      modeSelect.value = mode;
    } else {
      mode = "practice";
    }
    applyFontSize();
    updateKeypadVisibility();
  } catch(e){
    numbersPerQuestion = parseInt(setCountPerQuestion.value) || 5;
    totalQuestions     = parseInt(setTotalQuestions.value) || 10;
    speedMs            = parseInt(setSpeed.value) || 800;
    fontSizeSetting    = setFontSize.value || "medium";
    mode               = modeSelect ? modeSelect.value : "practice";
    applyFontSize();
    updateKeypadVisibility();
  }
}

function saveSettings() {
  ensureModeSelector();
  numbersPerQuestion = parseInt(setCountPerQuestion.value) || 5;
  totalQuestions     = parseInt(setTotalQuestions.value)   || 10;
  speedMs            = parseInt(setSpeed.value)            || 800;
  fontSizeSetting    = setFontSize.value || "medium";
  mode               = modeSelect ? modeSelect.value : "practice";

  const data = {
    numbersPerQuestion,
    totalQuestions,
    speedMs,
    fontSizeSetting,
    mode
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(data));
  applyFontSize();
  updateKeypadVisibility();
}

function applyFontSize() {
  let sizeRem = 3;
  switch(fontSizeSetting){
    case "small": sizeRem = 2.4; break;
    case "medium": sizeRem = 3; break;
    case "large": sizeRem = 3.8; break;
    case "xl": sizeRem = 4.6; break;
    case "xxl": sizeRem = 5.4; break;
  }
  displayBox.style.fontSize = sizeRem + "rem";
}

function updateKeypadVisibility() {
  if (mode === "challenge") {
    keypadArea.style.display = "block";
  } else {
    keypadArea.style.display = "none";
  }
}

// --------- สุ่มเลข & ลูปแสดงตัวเลข ---------
function generateSequence() {
  currentSequence = [];
  currentAnswer   = 0;
  currentIndexInSeq = 0;

  const count = Math.max(1, Math.min(99, numbersPerQuestion));

  for (let i = 0; i < count; i++) {
    // สุ่มเลข 1 หลัก 1–9 (ไม่เอา 0)
    const n = Math.floor(Math.random() * 9) + 1;
    currentSequence.push(n);
    currentAnswer += n;
  }
}

function showNextNumber() {
  if (!isRunning) return;

  if (currentIndexInSeq < currentSequence.length) {
    const n = currentSequence[currentIndexInSeq];
    displayBox.textContent = n.toString();
    playBeep(900, 0.08);

    // เริ่มจับเวลาโหมดท้าทายเมื่อแสดงเลขตัวแรกของข้อแรก
    if (mode === "challenge" && currentQuestionIndex === 1 && currentIndexInSeq === 0) {
      if (!challengeStartTime) {
        challengeStartTime = performance.now();
      }
    }

    currentIndexInSeq++;

    const showTime  = Math.max(100, Math.min(5000, speedMs));
    const blankTime = Math.min(500, Math.floor(showTime / 2));

    mainTimer = setTimeout(() => {
      if (!isRunning) return;
      displayBox.textContent = "";
      mainTimer = setTimeout(showNextNumber, blankTime);
    }, showTime);
  } else {
    // จบลิสต์เลขแล้ว
    if (mode === "practice") {
      startPracticeAnswerPhase();
    } else {
      startChallengeAnswerPhase();
    }
  }
}

// --------- โหมดฝึกฝน: "ตอบ" กระพริบ แล้วเฉลย ---------
function startPracticeAnswerPhase() {
  if (!isRunning) return;

  let count = 0;
  const totalBlinks = 6; // show/blank = 6 step (3 ครั้ง)
  const interval = 1000; // 1 วิ ต่อ 1 step

  function blink() {
    if (!isRunning) return;
    displayBox.textContent = (count % 2 === 0) ? "ตอบ" : "";
    if (count % 2 === 0) playBeep(1000, 0.08);
    count++;
    if (count < totalBlinks) {
      blinkTimer = setTimeout(blink, interval);
    } else {
      // เว้นอีก 1 วิ แล้วโชว์เฉลย
      blinkTimer = setTimeout(() => {
        if (!isRunning) return;
        displayBox.textContent = currentAnswer.toString();
        playBeep(1200, 0.12);
        // รอ 2 วิ แล้วไปข้อถัดไป หรือจบ
        mainTimer = setTimeout(() => {
          if (!isRunning) return;
          if (currentQuestionIndex >= totalQuestions) {
            finishPracticeSession();
          } else {
            currentQuestionIndex++;
            startQuestion();
          }
        }, 2000);
      }, 1000);
    }
  }
  blink();
}

function finishPracticeSession() {
  isRunning = false;
  displayBox.textContent = `ครบ ${totalQuestions} ข้อ`;

  // บันทึกผลโหมดฝึกฝน
  if (currentUser) {
    const key = "practice_results_" + currentUser;
    let arr = [];
    try {
      const raw = localStorage.getItem(key);
      if (raw) {
        const tmp = JSON.parse(raw);
        if (Array.isArray(tmp)) arr = tmp;
      }
    } catch(e){}
    arr.push({
      date: new Date().toISOString(),
      numbersPerQuestion,
      totalQuestions,
      speedMs
    });
    localStorage.setItem(key, JSON.stringify(arr));
  }
}

// --------- โหมดท้าทาย: ตอบผ่าน keypad ---------
function startChallengeAnswerPhase() {
  if (!isRunning) return;
  // แสดงข้อความให้ตอบ
  displayBox.textContent = "ตอบ";
  playBeep(1000, 0.08);
  answerInput.value = "";
}

function submitChallengeAnswer() {
  if (!isRunning || mode !== "challenge") return;
  const val = answerInput.value.trim();
  if (!val) return;

  const userAns = parseInt(val, 10);
  if (isNaN(userAns)) {
    answerInput.value = "";
    return;
  }

  if (userAns === currentAnswer) {
    // ถูก
    challengeCorrect++;
    displayBox.textContent = "ถูกต้อง!";
    playBeep(1200, 0.12);
    answerInput.value = "";

    if (challengeCorrect >= challengeTarget) {
      finishChallengeSession();
    } else {
      // ไปข้อถัดไป
      currentQuestionIndex++;
      mainTimer = setTimeout(() => {
        if (!isRunning) return;
        startQuestion();
      }, 700);
    }
  } else {
    // ผิด → สุ่มโจทย์ใหม่ทันที
    challengeMistakes++;
    displayBox.textContent = "ยังไม่ถูก";
    playBeep(500, 0.12);
    answerInput.value = "";
    mainTimer = setTimeout(() => {
      if (!isRunning) return;
      // ข้อนี้ใหม่ (ไม่เพิ่มเลขข้อ)
      startQuestion(/*sameIndex*/);
    }, 700);
  }
}

function finishChallengeSession() {
  isRunning = false;
  const endTime = performance.now();
  let totalSec = 0;
  if (challengeStartTime != null) {
    totalSec = (endTime - challengeStartTime) / 1000;
  }
  displayBox.textContent = `จบ! ${totalSec.toFixed(2)} วินาที`;

  // บันทึกผลโหมดท้าทาย
  if (currentUser) {
    const key = "challenge_results_" + currentUser;
    let arr = [];
    try {
      const raw = localStorage.getItem(key);
      if (raw) {
        const tmp = JSON.parse(raw);
        if (Array.isArray(tmp)) arr = tmp;
      }
    } catch(e){}
    arr.push({
      date: new Date().toISOString(),
      time: totalSec,
      mistakes: challengeMistakes,
      target: challengeTarget
    });
    localStorage.setItem(key, JSON.stringify(arr));
  }
}

// --------- เริ่มเกม / ปุ่มควบคุมหลัก ---------
function startGame() {
  if (!currentUser) {
    alert("กรุณาเข้าสู่ระบบก่อน");
    return;
  }
  saveSettings();
  if (isRunning) return;
  isRunning = true;

  // รีเซ็ต state
  currentQuestionIndex = 1;
  currentSequence = [];
  currentAnswer = 0;
  currentIndexInSeq = 0;
  clearTimers();

  // รีเซ็ตโหมดท้าทาย
  challengeCorrect = 0;
  challengeMistakes = 0;
  challengeTarget = totalQuestions;
  challengeStartTime = null;

  // แสดง "พร้อม!!" แล้ว "เริ่ม!!" แล้วไปข้อ 1
  displayBox.textContent = "พร้อม!!";
  playBeep(800, 0.12);

  mainTimer = setTimeout(() => {
    if (!isRunning) return;
    displayBox.textContent = "เริ่ม!!";
    playBeep(1000, 0.12);
    mainTimer = setTimeout(() => {
      if (!isRunning) return;
      startQuestion();
    }, 800);
  }, 800);
}

function startQuestion() {
  if (!isRunning) return;
  clearTimers();

  // แสดงเลขข้อก่อน
  displayBox.textContent = `ข้อ ${currentQuestionIndex}`;
  playBeep(750, 0.08);

  // สร้างโจทย์ใหม่
  generateSequence();

  mainTimer = setTimeout(() => {
    if (!isRunning) return;
    currentIndexInSeq = 0;
    showNextNumber();
  }, 700);
}

function stopGame() {
  isRunning = false;
  clearTimers();
}

function resetGame() {
  stopGame();
  currentSequence = [];
  currentAnswer = 0;
  currentIndexInSeq = 0;
  currentQuestionIndex = 0;
  challengeCorrect = 0;
  challengeMistakes = 0;
  challengeStartTime = null;
  displayBox.textContent = "พร้อม";
  answerInput.value = "";
}

function clearTimers() {
  if (mainTimer) {
    clearTimeout(mainTimer);
    mainTimer = null;
  }
  if (blinkTimer) {
    clearTimeout(blinkTimer);
    blinkTimer = null;
  }
}

// --------- Fullscreen (กึ่งเต็มจอ) ---------
function toggleFullscreen() {
  const docEl = document.documentElement;
  const isFS = !!(
    document.fullscreenElement ||
    document.webkitFullscreenElement ||
    document.mozFullScreenElement ||
    document.msFullscreenElement
  );

  if (!isFS) {
    if (docEl.requestFullscreen) docEl.requestFullscreen();
    else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen();
    else if (docEl.mozRequestFullScreen) docEl.mozRequestFullScreen();
    else if (docEl.msRequestFullscreen) docEl.msRequestFullscreen();
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
    else if (document.msExitFullscreen) document.msExitFullscreen();
  }
}

// --------- Keypad / ป้อนคำตอบโหมดท้าทาย ---------
function buildKeypad() {
  if (!keypadDiv) return;
  keypadDiv.innerHTML = "";
  const layout = [7,8,9,4,5,6,1,2,3,0];
  layout.forEach(n => {
    const btn = document.createElement("button");
    btn.textContent = n.toString();
    btn.addEventListener("click", () => {
      answerInput.value += n.toString();
    });
    keypadDiv.appendChild(btn);
  });
}

function handleKeyEnter() { submitChallengeAnswer(); }
function handleKeyBack() {
  answerInput.value = answerInput.value.slice(0, -1);
}
function handleKeyClear() {
  answerInput.value = "";
}

// รองรับคีย์บอร์ดจริงด้วย
function handleGlobalKeydown(e) {
  if (!isRunning || mode !== "challenge") return;
  if (e.key >= "0" && e.key <= "9") {
    e.preventDefault();
    answerInput.value += e.key;
  } else if (e.key === "Backspace") {
    e.preventDefault();
    answerInput.value = answerInput.value.slice(0, -1);
  } else if (e.key === "Enter") {
    e.preventDefault();
    submitChallengeAnswer();
  }
}

// --------- Initial Setup ---------
window.addEventListener("DOMContentLoaded", () => {
  // โหลด users + currentUser
  loadUsers();
  const stored = localStorage.getItem(CURRENT_USER_KEY);
  if (stored && users.find(x => x.username === stored)) {
    currentUser = stored;
    loginOverlay.style.display = "none";
  } else {
    loginOverlay.style.display = "flex";
  }
  updateCurrentUserBox();

  // สร้าง selector โหมด
  ensureModeSelector();
  // โหลด settings
  loadSettings();

  // keypad
  buildKeypad();

  // ปุ่ม login
  if (loginBtn) {
    loginBtn.addEventListener("click", () => {
      tryLogin();
    });
  }
  if (loginUserInput && loginPassInput) {
    const handler = (e) => {
      if (e.key === "Enter") {
        tryLogin();
      }
    };
    loginUserInput.addEventListener("keydown", handler);
    loginPassInput.addEventListener("keydown", handler);
  }

  // ปุ่มเมนูหลัก
  if (btnSettings) {
    btnSettings.addEventListener("click", () => {
      if (!settingsPanel) return;
      const visible = settingsPanel.style.display !== "none";
      settingsPanel.style.display = visible ? "none" : "block";
    });
  }
  if (btnStart)  btnStart.addEventListener("click", startGame);
  if (btnStop)   btnStop.addEventListener("click", stopGame);
  if (btnReset)  btnReset.addEventListener("click", resetGame);
  if (btnFullscreen) btnFullscreen.addEventListener("click", toggleFullscreen);

  // ปุ่มใน settings เปลี่ยน -> saveSettings
  [setCountPerQuestion, setTotalQuestions, setSpeed, setFontSize].forEach(el => {
    if (!el) return;
    el.addEventListener("change", saveSettings);
    el.addEventListener("input", saveSettings);
  });
  if (modeSelect) {
    modeSelect.addEventListener("change", saveSettings);
  }

  // admin toggle
  if (adminToggleBtn) {
    adminToggleBtn.addEventListener("click", () => {
      if (!isAdminMode) {
        if (askAdminPassword()) {
          isAdminMode = true;
          adminPanel.style.display = "block";
          renderUserList();
        }
      } else {
        isAdminMode = false;
        adminPanel.style.display = "none";
      }
    });
  }
  if (adminAddUserBtn) {
    adminAddUserBtn.addEventListener("click", addUserFromAdmin);
  }
  if (adminResetAllBtn) {
    adminResetAllBtn.addEventListener("click", resetAllStats);
  }

  // keypad buttons
  if (keyEnter) keyEnter.addEventListener("click", handleKeyEnter);
  if (keyBack)  keyBack.addEventListener("click", handleKeyBack);
  if (keyClear) keyClear.addEventListener("click", handleKeyClear);

  document.addEventListener("keydown", handleGlobalKeydown);

  // ตั้งค่าเริ่มต้นใน display
  displayBox.textContent = "พร้อม";
});

</script>

</body>
</html>
