<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏Ñ‡∏£‡∏π‡πÄ‡∏≠‡∏ü ‡∏à‡∏¥‡∏ô‡∏ï‡∏Ñ‡∏ì‡∏¥‡∏ï - ‡πÅ‡∏≠‡∏õ‡∏ù‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡πá‡∏ß</title>

<style>
/* ========= RESET ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ========= */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #fef3c7; /* ‡πÇ‡∏ó‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô */
  color: #111827;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

/* ========= HEADER ========= */
.app-header {
  text-align: center;
  padding: 10px 8px 4px;
}

.app-header h2 {
  font-size: 1.4rem;
  font-weight: 800;
  color: #ea580c; /* ‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏° */
  text-shadow: 0 1px 2px rgba(248, 250, 252, 0.8);
}

/* ========= HERO + MASCOT ========= */
.hero-wrapper {
  width: 90%;
  max-width: 480px;
  margin: 4px auto 6px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.hero-text {
  flex: 1.2;
}

.hero-title {
  font-size: 1rem;
  font-weight: 800;
  color: #ea580c;
}

.hero-sub {
  font-size: 0.78rem;
  color: #4b5563;
  line-height: 1.3;
}

.hero-mascot {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

/* ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏°‡∏≤‡∏™‡∏Ñ‡∏≠‡∏ï + ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á */
.mascot-circle {
  width: 70px;
  height: 70px;
  border-radius: 999px;
  background: radial-gradient(circle at 30% 20%, #fed7aa, #f97316);
  box-shadow: 0 6px 14px rgba(248,113,22,0.6);
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: floatUpDown 2.5s ease-in-out infinite;
}

.mascot-face {
  position: absolute;
  top: 14px;
  width: 40px;
  height: 28px;
  border-radius: 999px;
  background: #fee2e2;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mascot-eyes {
  display: flex;
  justify-content: space-between;
  padding: 6px 8px 0;
}

.mascot-eyes .eye {
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: #111827;
}

.mascot-mouth {
  width: 16px;
  height: 8px;
  border-radius: 0 0 999px 999px;
  border-bottom: 2px solid #f97316;
  margin: 2px auto 0;
}

.mascot-abacus {
  position: absolute;
  bottom: 6px;
  right: 4px;
  font-size: 1rem;
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏û‡∏π‡∏î */
.mascot-speech {
  max-width: 140px;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 12px;
  background: #fff7ed;
  border: 1px solid rgba(248,171,95,0.8);
  color: #7c2d12;
  position: relative;
}

.mascot-speech::after {
  content: "";
  position: absolute;
  top: -6px;
  left: 10px;
  border-width: 0 6px 6px 6px;
  border-style: solid;
  border-color: transparent transparent rgba(248,171,95,0.8) transparent;
}

/* keyframes ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏•‡∏≠‡∏¢ */
@keyframes floatUpDown {
  0%   { transform: translateY(0px); }
  50%  { transform: translateY(-4px); }
  100% { transform: translateY(0px); }
}

@media (min-width: 768px) {
  .hero-wrapper {
    max-width: 520px;
  }
}

/* ========= TOP MENU BAR ========= */
.menu-bar {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 6px 8px 4px;
  flex-wrap: wrap;
}

.menu-bar button {
  min-width: 70px;
  padding: 8px 10px;
  border-radius: 999px;
  border: none;
  background: #f97316;
  color: #fff;
  font-size: 0.8rem;
  font-weight: 600;
  box-shadow: 0 2px 5px rgba(249,115,22,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.menu-bar button:active {
  transform: translateY(1px) scale(0.97);
  box-shadow: 0 1px 3px rgba(249,115,22,0.6);
}

/* ========= DISPLAY BOX ========= */
.display-box {
  margin: 6px auto 4px;
  width: 90%;
  max-width: 480px;
  border-radius: 16px;
  background: radial-gradient(circle at top, #fed7aa, #fff7ed);
  border: 1px solid rgba(248, 171, 95, 0.5);
  box-shadow: 0 6px 16px rgba(248,171,95,0.35);
  text-align: center;
  color: #111827;
  font-weight: 800;
  font-size: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 120px;
  max-height: 140px;
  padding: 10px;
}

/* ========= SETTINGS PANEL ========= */
.settings-panel {
  width: 90%;
  max-width: 480px;
  margin: 6px auto 0;
  background: #f9fafb;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.5);
  box-shadow: 0 4px 10px rgba(148,163,184,0.2);
  padding: 10px 12px 12px;
  font-size: 0.85rem;
}

.settings-panel h3 {
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: #374151;
}

.settings-panel label {
  display: block;
  margin-top: 6px;
  margin-bottom: 2px;
  font-weight: 600;
  color: #4b5563;
}

.settings-panel input[type="number"],
.settings-panel select {
  width: 100%;
  padding: 4px 6px;
  border-radius: 8px;
  border: 1px solid #cbd5f5;
  font-size: 0.85rem;
  background: #ffffff;
}

.settings-panel .inline-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

.settings-panel .inline-label input {
  width: auto;
}

.settings-panel hr {
  border: none;
  border-top: 1px dashed rgba(148,163,184,0.6);
  margin: 10px 0 6px;
}

/* ========= ADMIN PANEL ========= */
#adminPanel h4 {
  margin-bottom: 6px;
  font-size: 0.9rem;
  color: #111827;
}

#adminPanel input {
  border-radius: 8px;
  border: 1px solid #cbd5f5;
  font-size: 0.8rem;
  background: #ffffff;
}

#adminUserList {
  font-size: 0.78rem;
}

#adminUserList div {
  border-bottom: 1px solid rgba(209,213,219,0.8);
}

#adminUserList div:last-child {
  border-bottom: none;
}

/* ========= KEYPAD / ANSWER AREA ========= */
.keypad-area {
  width: 90%;
  max-width: 480px;
  margin: 10px auto 14px;
  background: #f9fafb;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.5);
  box-shadow: 0 4px 10px rgba(148,163,184,0.25);
  padding: 10px 10px 12px;
}

.answer-input {
  width: 100%;
  padding: 6px 8px;
  border-radius: 10px;
  border: 2px solid #f97316;
  font-size: 1.8rem;
  text-align: center;
  margin-bottom: 8px;
  background: #ffffff;
}

/* keypad ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô 0‚Äì9 */
.keypad {
  display: flex;
  flex-wrap: nowrap;
  gap: 6px;
  margin-bottom: 8px;
  overflow-x: auto;
  padding-bottom: 4px;
}

.keypad button {
  flex: 1 0 0;
  min-width: 40px;
  height: 44px;
  border-radius: 8px;
  border: none;
  background: #e5e7eb;
  box-shadow: 0 2px 4px rgba(107,114,128,0.6);
  font-size: 1rem;
  font-weight: 700;
  color: #111827;
  display: flex;
  align-items: center;
  justify-content: center;
}

.keypad button:active {
  transform: translateY(1px) scale(0.98);
  box-shadow: 0 1px 3px rgba(107,114,128,0.7);
}

/* ========= ‡πÅ‡∏ñ‡∏ö‡∏õ‡∏∏‡πà‡∏° Delete / Clear / Enter ========= */
.action-buttons {
  display: flex;
  justify-content: space-between;
  gap: 6px;
  margin-top: 8px;
}

.action-buttons button {
  flex: 1;
  height: 70px;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  cursor: pointer;
}

.btn-delete {
  background: #dc2626;
  color: white;
}

.btn-clear {
  background: #f97316;
  color: white;
}

.btn-enter {
  background: #16a34a;
  color: white;
  font-size: 1.05rem;
}

/* ========= DARK MODE ========= */
body.dark-mode {
  background:#020617;
  color:#e5e7eb;
}

body.dark-mode .app-header h2 {
  color:#fb923c;
  text-shadow:none;
}

body.dark-mode .display-box {
  background: radial-gradient(circle at top,#0f172a,#020617);
  border-color:#334155;
  color:#e5e7eb;
}

body.dark-mode .settings-panel,
body.dark-mode .keypad-area {
  background:#020617;
  border-color:#1e293b;
  box-shadow:0 4px 10px rgba(15,23,42,0.8);
}

body.dark-mode .settings-panel label,
body.dark-mode .settings-panel h3 {
  color:#e5e7eb;
}

body.dark-mode .settings-panel input[type="number"],
body.dark-mode .settings-panel select {
  background:#020617;
  color:#e5e7eb;
  border-color:#334155;
}

body.dark-mode .keypad-area {
  background:#020617;
}

body.dark-mode .answer-input {
  background:#020617;
  color:#e5e7eb;
  border-color:#f97316;
}

body.dark-mode .keypad button {
  background:#1f2937;
  color:#e5e7eb;
}

body.dark-mode .action-buttons button {
  box-shadow:0 2px 4px rgba(0,0,0,0.7);
}

/* ========= RESPONSIVE ========= */
@media (min-width: 768px) {
  .display-box {
    max-width: 520px;
    min-height: 140px;
    max-height: 160px;
    font-size: 3.5rem;
  }

  .settings-panel,
  .keypad-area {
    max-width: 520px;
  }
}
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" style="
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999;
">
  <div style="
    width: 90%; max-width: 320px;
    background: white; padding: 20px;
    border-radius: 16px; text-align: center;
  ">
    <h3 style="margin: 0;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
    <p style="font-size: 0.85rem; color:#555; margin-top:4px;">
      ‡πÉ‡∏™‡πà Username ‡πÅ‡∏•‡∏∞ Password
    </p>

    <input id="loginUser"
           type="text"
           placeholder="Username"
           style="width: 90%; padding:8px; margin-top:10px;
                  border-radius:8px; border:1px solid #ccc;">

    <input id="loginPass"
           type="password"
           placeholder="Password"
           style="width: 90%; padding:8px; margin-top:8px;
                  border-radius:8px; border:1px solid #ccc;">

    <div id="loginError" style="color:red; font-size:0.8rem; min-height:1.2rem;"></div>

    <button id="loginBtn"
            style="padding:8px 20px; margin-top:10px;
                   border:none; border-radius:999px;
                   background:#f97316; color:white; font-weight:600;">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    </button>
  </div>
</div>

<!-- HEADER -->
<div class="app-header">
  <h2>‡∏Ñ‡∏£‡∏π‡πÄ‡∏≠‡∏ü ‡∏à‡∏¥‡∏ô‡∏ï‡∏Ñ‡∏ì‡∏¥‡∏ï</h2>
  <div id="currentUserBox" style="font-size:0.85rem; color:#333;"></div>
</div>

<!-- HERO -->
<div class="hero-wrapper">
  <div class="hero-text">
    <div class="hero-title">‡πÄ‡∏Å‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡πÑ‡∏ß‡πÅ‡∏ö‡∏ö‡∏™‡∏ô‡∏∏‡∏Å</div>
    <div class="hero-sub">
      ‡∏ù‡∏∂‡∏Å‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤<br>
      ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏Ç‡πà‡∏á‡πÇ‡∏´‡∏°‡∏î ‚Äú‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‚Äù ‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ!
    </div>
  </div>
  <div class="hero-mascot">
    <div class="mascot-circle">
      <div class="mascot-face">
        <div class="mascot-eyes">
          <span class="eye"></span>
          <span class="eye"></span>
        </div>
        <div class="mascot-mouth"></div>
      </div>
      <div class="mascot-abacus">üßÆ</div>
    </div>
    <div class="mascot-speech" id="mascotSpeech">
      ‡∏°‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡∏î‡∏π‡πÑ‡∏´‡∏°?
    </div>
  </div>
</div>

<!-- MENU BAR -->
<div class="menu-bar">
  <button id="btnSettings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
  <button id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
  <button id="btnStop">‡∏´‡∏¢‡∏∏‡∏î</button>
  <button id="btnReset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
  <button id="btnFullscreen">‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
</div>

<!-- DISPLAY BOX -->
<div id="displayBox" class="display-box">‡∏û‡∏£‡πâ‡∏≠‡∏°</div>

<!-- SETTINGS PANEL -->
<div id="settingsPanel" class="settings-panel" style="display:none;">

  <h3>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>

  <label>‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</label>
  <select id="setMode">
    <option value="practice">‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</option>
    <option value="challenge">‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (‡∏ï‡∏≠‡∏ö‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</option>
  </select>

  <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏à‡∏ó‡∏¢‡πå</label>
  <select id="setOpType">
    <option value="plus">‡∏ö‡∏ß‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
    <option value="plusMinus">‡∏ö‡∏ß‡∏Å + ‡∏•‡∏ö</option>
  </select>

  <label class="inline-label">
    <input type="checkbox" id="setNoZero" checked>
    ‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç 0
  </label>

  <label class="inline-label">
    <input type="checkbox" id="setPreventNegative" checked>
    ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö
  </label>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πà‡∏≠ 1 ‡∏Ç‡πâ‡∏≠</label>
  <input id="setCountPerQuestion" type="number" min="1" max="99" value="5">

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô 1 ‡∏£‡∏≠‡∏ö</label>
  <input id="setTotalQuestions" type="number" min="1" max="99" value="10">

  <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (ms)</label>
  <input id="setSpeed" type="number" min="100" max="5000" value="800">

  <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</label>
  <select id="setFontSize">
    <option value="small">‡πÄ‡∏•‡πá‡∏Å</option>
    <option value="medium" selected>‡∏Å‡∏•‡∏≤‡∏á</option>
    <option value="large">‡πÉ‡∏´‡∏ç‡πà</option>
    <option value="xl">XL</option>
    <option value="xxl">XXL</option>
  </select>

  <label>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</label>
  <select id="setSound">
    <option value="on" selected>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
    <option value="off">‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</option>
  </select>

  <label>‡∏ò‡∏µ‡∏° / ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≠</label>
  <select id="setTheme">
    <option value="light" selected>‡πÇ‡∏ó‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</option>
    <option value="dark">‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏° (Dark Mode)</option>
  </select>

  <hr>

  <button id="adminToggleBtn"
          style="background:#6b7280; color:white; border:none;
                 padding:6px 12px; border-radius:8px;">
    ‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Admin)
  </button>

  <div id="adminPanel" style="display:none; margin-top:10px; 
                              background:#f3f4f6; padding:12px; border-radius:10px;">

    <h4>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h4>

    <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:10px;">
      <input id="adminNewUser" type="text" placeholder="username"
             style="flex:1; padding:4px;">
      <input id="adminNewPass" type="text" placeholder="password"
             style="flex:1; padding:4px;">
      <input id="adminNewName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á"
             style="flex:1; padding:4px;">
      <button id="adminAddUserBtn"
              style="padding:4px 10px; background:#22c55e; color:white;
                     border:none; border-radius:6px;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>

    <div style="margin-top:6px; font-weight:600;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
    <div id="adminUserList"
         style="max-height:150px; overflow:auto; background:white;
                border:1px solid #ddd; padding:6px; border-radius:8px;">
      (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶)
    </div>

    <button id="adminResetAllBtn"
            style="margin-top:10px; padding:4px 10px; background:#ef4444; color:white;
                   border:none; border-radius:6px;">
      ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>

  </div>

</div>

<!-- CHALLENGE KEYPAD -->
<div id="keypadArea" class="keypad-area" style="display:none;">
  <input id="answerInput" type="text" readonly class="answer-input">

  <div class="keypad">
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ JS -->
  </div>

  <div class="action-buttons">
    <button id="keyDelete" class="btn-delete">Delete</button>
    <button id="keyClear"  class="btn-clear">Clear</button>
    <button id="keyEnter"  class="btn-enter">Enter</button>
  </div>
</div>

<script>
/********************************************
 *  JavaScript ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ
 ********************************************/

// ‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö localStorage
const USERS_KEY          = "kruF_users_v1";
const CURRENT_USER_KEY   = "kruF_current_user_v1";
const SETTINGS_KEY       = "kruF_settings_v1";
const ADMIN_PASSWORD     = "KF888";      // ‡∏£‡∏´‡∏±‡∏™ admin

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ / admin
let users = [];
let currentUser = null;
let isAdminMode = false;

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡∏°
let mode = "practice";        // practice / challenge
let opType = "plus";          // plus / plusMinus
let noZero = true;
let preventNegative = true;
let soundSetting = "on";      // on / off
let themeSetting = "light";   // light / dark
let soundEnabled = true;

let isRunning = false;
let numbersPerQuestion = 5;
let totalQuestions = 10;
let speedMs = 800;
let fontSizeSetting = "medium";

let currentQuestionIndex = 0;
let currentSequence = [];
let currentAnswer = 0;
let currentIndexInSeq = 0;

let mainTimer = null;
let blinkTimer = null;

// challenge mode
let challengeCorrect = 0;
let challengeMistakes = 0;
let challengeTarget = 10;
let challengeStartTime = null;

// DOM refs
const loginOverlay   = document.getElementById("loginOverlay");
const loginUserInput = document.getElementById("loginUser");
const loginPassInput = document.getElementById("loginPass");
const loginBtn       = document.getElementById("loginBtn");
const loginErrorBox  = document.getElementById("loginError");

const currentUserBox = document.getElementById("currentUserBox");

const btnSettings    = document.getElementById("btnSettings");
const btnStart       = document.getElementById("btnStart");
const btnStop        = document.getElementById("btnStop");
const btnReset       = document.getElementById("btnReset");
const btnFullscreen  = document.getElementById("btnFullscreen");

const displayBox     = document.getElementById("displayBox");
const settingsPanel  = document.getElementById("settingsPanel");

const setMode        = document.getElementById("setMode");
const setOpType      = document.getElementById("setOpType");
const setNoZero      = document.getElementById("setNoZero");
const setPreventNegative = document.getElementById("setPreventNegative");
const setCountPerQuestion = document.getElementById("setCountPerQuestion");
const setTotalQuestions   = document.getElementById("setTotalQuestions");
const setSpeed            = document.getElementById("setSpeed");
const setFontSize         = document.getElementById("setFontSize");
const setSound            = document.getElementById("setSound");
const setTheme            = document.getElementById("setTheme");

const adminToggleBtn      = document.getElementById("adminToggleBtn");
const adminPanel          = document.getElementById("adminPanel");
const adminNewUser        = document.getElementById("adminNewUser");
const adminNewPass        = document.getElementById("adminNewPass");
const adminNewName        = document.getElementById("adminNewName");
const adminAddUserBtn     = document.getElementById("adminAddUserBtn");
const adminUserList       = document.getElementById("adminUserList");
const adminResetAllBtn    = document.getElementById("adminResetAllBtn");

const keypadArea          = document.getElementById("keypadArea");
const answerInput         = document.getElementById("answerInput");
const keypadDiv           = document.querySelector(".keypad");
const keyEnter            = document.getElementById("keyEnter");
const keyDelete           = document.getElementById("keyDelete");
const keyClear            = document.getElementById("keyClear");

const mascotSpeech        = document.getElementById("mascotSpeech");

// Audio
let audioCtx = null;
function initAudio() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (AC) audioCtx = new AC();
  }
}

function playBeep(freq=900, duration=0.08) {
  if (!soundEnabled) return;
  try {
    initAudio();
    if (!audioCtx) return;
    const osc  = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.01);
    gain.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration + 0.03);
  } catch(e){}
}

// Mascot speech
function setMascotSpeech(text) {
  if (mascotSpeech) mascotSpeech.textContent = text;
}

// Users / login
function loadUsers() {
  const raw = localStorage.getItem(USERS_KEY);
  if (!raw) {
    users = [{
      username: "admin",
      password: "KF888",
      displayName: "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"
    }];
    saveUsers();
    return;
  }
  try {
    const arr = JSON.parse(raw);
    if (Array.isArray(arr) && arr.length > 0) {
      users = arr;
    } else {
      users = [{
        username: "admin",
        password: "KF888",
        displayName: "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"
      }];
      saveUsers();
    }
  } catch(e) {
    users = [{
      username: "admin",
      password: "KF888",
      displayName: "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"
    }];
    saveUsers();
  }
}

function saveUsers() {
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

function updateCurrentUserBox() {
  if (!currentUser) {
    currentUserBox.innerHTML = `<span style="color:#ef4444;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>`;
    return;
  }
  const u = users.find(x => x.username === currentUser);
  const displayName = u ? (u.displayName || u.username) : currentUser;
  currentUserBox.innerHTML = `
    ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <b>${displayName}</b> (${currentUser})
    <button onclick="logoutUser()" 
            style="margin-left:6px; padding:2px 8px; border:none;
                   border-radius:999px; background:#ef4444; color:white;
                   font-size:0.75rem;">
      ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    </button>
  `;
}

function tryLogin() {
  const u = loginUserInput.value.trim();
  const p = loginPassInput.value.trim();
  loginErrorBox.textContent = "";

  if (!u || !p) {
    loginErrorBox.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
    return;
  }
  const rec = users.find(x => x.username === u);
  if (!rec) {
    loginErrorBox.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö username ‡∏ô‡∏µ‡πâ";
    return;
  }
  if (rec.password !== p) {
    loginErrorBox.textContent = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    return;
  }

  currentUser = rec.username;
  localStorage.setItem(CURRENT_USER_KEY, currentUser);
  loginOverlay.style.display = "none";
  updateCurrentUserBox();
  setMascotSpeech("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ " + (rec.displayName || rec.username) + " ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?");
}

function logoutUser() {
  currentUser = null;
  localStorage.removeItem(CURRENT_USER_KEY);
  loginOverlay.style.display = "flex";
  updateCurrentUserBox();
  stopGame();
  setMascotSpeech("‡∏°‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡∏î‡∏π‡πÑ‡∏´‡∏°?");
}
window.logoutUser = logoutUser;

// Admin
function askAdminPassword() {
  const input = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Admin)");
  if (input === null) return false;
  if (input === ADMIN_PASSWORD) {
    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏•‡πâ‡∏ß");
    return true;
  } else {
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return false;
  }
}

function renderUserList() {
  adminUserList.innerHTML = "";
  if (!users.length) {
    adminUserList.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
    return;
  }

  users.forEach((u, i) => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.alignItems = "center";
    row.style.padding = "2px 0";

    const practiceKey  = "practice_results_" + u.username;
    const challengeKey = "challenge_results_" + u.username;
    let pracCount = 0;
    let chalCount = 0;

    try {
      const pRaw = localStorage.getItem(practiceKey);
      if (pRaw) {
        const arr = JSON.parse(pRaw);
        if (Array.isArray(arr)) pracCount = arr.length;
      }
      const cRaw = localStorage.getItem(challengeKey);
      if (cRaw) {
        const arr2 = JSON.parse(cRaw);
        if (Array.isArray(arr2)) chalCount = arr2.length;
      }
    } catch(e){}

    const left = document.createElement("span");
    left.innerHTML = `${i+1}. <b>${u.displayName || u.username}</b> (${u.username})<br>
      ‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô: ${pracCount} ‡∏£‡∏≠‡∏ö | ‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢: ${chalCount} ‡∏£‡∏≠‡∏ö`;

    const btns = document.createElement("span");

    const viewBtn = document.createElement("button");
    viewBtn.textContent = "‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥";
    viewBtn.style.border = "none";
    viewBtn.style.borderRadius = "999px";
    viewBtn.style.background = "#3b82f6";
    viewBtn.style.color = "#fff";
    viewBtn.style.fontSize = "0.7rem";
    viewBtn.style.padding = "2px 6px";
    viewBtn.style.marginRight = "3px";
    viewBtn.onclick = () => showUserStats(u.username);

    const editBtn = document.createElement("button");
    editBtn.textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
    editBtn.style.border = "none";
    editBtn.style.borderRadius = "999px";
    editBtn.style.background = "#f59e0b";
    editBtn.style.color = "#fff";
    editBtn.style.fontSize = "0.7rem";
    editBtn.style.padding = "2px 6px";
    editBtn.style.marginRight = "3px";
    editBtn.onclick = () => editUser(u.username);

    const delBtn = document.createElement("button");
    delBtn.textContent = "‡∏•‡∏ö";
    delBtn.style.border = "none";
    delBtn.style.borderRadius = "999px";
    delBtn.style.background = "#ef4444";
    delBtn.style.color = "#fff";
    delBtn.style.fontSize = "0.7rem";
    delBtn.style.padding = "2px 6px";
    delBtn.onclick = () => deleteUser(u.username);

    btns.appendChild(viewBtn);
    btns.appendChild(editBtn);
    if (u.username !== "admin") btns.appendChild(delBtn);

    row.appendChild(left);
    row.appendChild(btns);
    adminUserList.appendChild(row);
  });
}

function showUserStats(username) {
  const practiceKey  = "practice_results_" + username;
  const challengeKey = "challenge_results_" + username;

  let prac = [];
  let chal = [];
  try {
    const pRaw = localStorage.getItem(practiceKey);
    if (pRaw) {
      const arr = JSON.parse(pRaw);
      if (Array.isArray(arr)) prac = arr;
    }
    const cRaw = localStorage.getItem(challengeKey);
    if (cRaw) {
      const arr2 = JSON.parse(cRaw);
      if (Array.isArray(arr2)) chal = arr2;
    }
  } catch(e){}

  let msg = `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ${username}\n\n[‡πÇ‡∏´‡∏°‡∏î‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô] ‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${prac.length}\n`;
  prac.slice(-5).forEach((r, idx) => {
    msg += `- ‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${prac.length - (prac.slice(-5).length - idx) + 1}: `;
    msg += `‡∏Ç‡πâ‡∏≠: ${r.totalQuestions}, ‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠: ${r.numbersPerQuestion}, ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: ${r.speedMs}ms\n`;
  });

  msg += `\n[‡πÇ‡∏´‡∏°‡∏î‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢] ‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${chal.length}\n`;
  chal.slice(-5).forEach((r, idx) => {
    msg += `- ‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${chal.length - (chal.slice(-5).length - idx) + 1}: `;
    msg += `‡πÄ‡∏ß‡∏•‡∏≤: ${r.time.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ, ‡∏ú‡∏¥‡∏î: ${r.mistakes}\n`;
  });

  alert(msg);
}

function editUser(username) {
  const u = users.find(x => x.username === username);
  if (!u) return;
  const newName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà:", u.displayName || u.username);
  if (newName === null) return;
  const newPass = prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:", u.password);
  if (newPass === null) return;
  u.displayName = newName.trim() || u.username;
  u.password    = newPass.trim() || u.password;
  saveUsers();
  renderUserList();
  if (currentUser === u.username) updateCurrentUserBox();
}

function deleteUser(username) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ " + username + " ?")) return;
  users = users.filter(x => x.username !== username);
  saveUsers();
  localStorage.removeItem("practice_results_" + username);
  localStorage.removeItem("challenge_results_" + username);
  if (currentUser === username) {
    logoutUser();
  } else {
    renderUserList();
  }
}

function addUserFromAdmin() {
  const uname = (adminNewUser.value || "").trim();
  const pass  = (adminNewPass.value || "").trim();
  const name  = (adminNewName.value || "").trim();

  if (!uname || !pass) {
    alert("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å username ‡πÅ‡∏•‡∏∞ password");
    return;
  }
  if (users.find(x => x.username === uname)) {
    alert("‡∏°‡∏µ username ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }
  users.push({
    username: uname,
    password: pass,
    displayName: name || uname
  });
  saveUsers();
  adminNewUser.value = "";
  adminNewPass.value = "";
  adminNewName.value = "";
  renderUserList();
}

function resetAllStats() {
  if (!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
  users.forEach(u => {
    localStorage.removeItem("practice_results_" + u.username);
    localStorage.removeItem("challenge_results_" + u.username);
  });
  alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  renderUserList();
}

// Settings
function applyTheme() {
  const body = document.body;
  if (themeSetting === "dark") {
    body.classList.add("dark-mode");
  } else {
    body.classList.remove("dark-mode");
  }
}

function applyFontSize() {
  let sizeRem = 3;
  switch(fontSizeSetting){
    case "small": sizeRem = 2.4; break;
    case "medium": sizeRem = 3; break;
    case "large": sizeRem = 3.8; break;
    case "xl": sizeRem = 4.6; break;
    case "xxl": sizeRem = 5.4; break;
  }
  displayBox.style.fontSize = sizeRem + "rem";
}

function updateKeypadVisibility() {
  if (mode === "challenge") {
    keypadArea.style.display = "block";
  } else {
    keypadArea.style.display = "none";
  }
}

function loadSettings() {
  const raw = localStorage.getItem(SETTINGS_KEY);
  if (!raw) {
    numbersPerQuestion = parseInt(setCountPerQuestion.value) || 5;
    totalQuestions     = parseInt(setTotalQuestions.value) || 10;
    speedMs            = parseInt(setSpeed.value) || 800;
    fontSizeSetting    = setFontSize.value || "medium";
    mode               = setMode.value || "practice";
    opType             = setOpType.value || "plus";
    noZero             = setNoZero.checked;
    preventNegative    = setPreventNegative.checked;
    soundSetting       = setSound.value || "on";
    themeSetting       = setTheme.value || "light";
  } else {
    try {
      const s = JSON.parse(raw);
      if (s.numbersPerQuestion != null) {
        numbersPerQuestion = s.numbersPerQuestion;
        setCountPerQuestion.value = numbersPerQuestion;
      }
      if (s.totalQuestions != null) {
        totalQuestions = s.totalQuestions;
        setTotalQuestions.value = totalQuestions;
      }
      if (s.speedMs != null) {
        speedMs = s.speedMs;
        setSpeed.value = speedMs;
      }
      if (s.fontSizeSetting) {
        fontSizeSetting = s.fontSizeSetting;
        setFontSize.value = fontSizeSetting;
      }
      mode = s.mode || "practice";
      setMode.value = mode;

      opType = s.opType || "plus";
      setOpType.value = opType;

      noZero = typeof s.noZero === "boolean" ? s.noZero : true;
      setNoZero.checked = noZero;

      preventNegative = typeof s.preventNegative === "boolean" ? s.preventNegative : true;
      setPreventNegative.checked = preventNegative;

      soundSetting = s.sound || "on";
      setSound.value = soundSetting;

      themeSetting = s.theme || "light";
      setTheme.value = themeSetting;
    } catch(e) {
      // ‡∏ñ‡πâ‡∏≤ parse error ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏à‡∏≤‡∏Å input
      numbersPerQuestion = parseInt(setCountPerQuestion.value) || 5;
      totalQuestions     = parseInt(setTotalQuestions.value) || 10;
      speedMs            = parseInt(setSpeed.value) || 800;
      fontSizeSetting    = setFontSize.value || "medium";
      mode               = setMode.value || "practice";
      opType             = setOpType.value || "plus";
      noZero             = setNoZero.checked;
      preventNegative    = setPreventNegative.checked;
      soundSetting       = setSound.value || "on";
      themeSetting       = setTheme.value || "light";
    }
  }

  soundEnabled = (soundSetting === "on");
  applyFontSize();
  applyTheme();
  updateKeypadVisibility();
}

function saveSettings() {
  numbersPerQuestion = parseInt(setCountPerQuestion.value) || 5;
  totalQuestions     = parseInt(setTotalQuestions.value)   || 10;
  speedMs            = parseInt(setSpeed.value)            || 800;
  fontSizeSetting    = setFontSize.value || "medium";
  mode               = setMode.value || "practice";
  opType             = setOpType.value || "plus";
  noZero             = setNoZero.checked;
  preventNegative    = setPreventNegative.checked;
  soundSetting       = setSound.value || "on";
  themeSetting       = setTheme.value || "light";

  soundEnabled = (soundSetting === "on");

  const data = {
    numbersPerQuestion,
    totalQuestions,
    speedMs,
    fontSizeSetting,
    mode,
    opType,
    noZero,
    preventNegative,
    sound: soundSetting,
    theme: themeSetting
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(data));

  applyFontSize();
  applyTheme();
  updateKeypadVisibility();
}

// ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ö‡∏ß‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡∏ö‡∏ß‡∏Å-‡∏•‡∏ö)
function generateSequence() {
  currentSequence = [];
  currentAnswer   = 0;
  currentIndexInSeq = 0;

  const count = Math.max(1, Math.min(99, numbersPerQuestion));
  let sum = 0;

  for (let i = 0; i < count; i++) {
    let value;

    if (opType === "plus") {
      const min = noZero ? 1 : 0;
      value = Math.floor(Math.random() * (10 - min)) + min; // min..9
      sum += value;
    } else {
      // ‡∏ö‡∏ß‡∏Å + ‡∏•‡∏ö
      const min = noZero ? 1 : 0;
      let mag = Math.floor(Math.random() * (10 - min)) + min; // 1..9 ‡∏´‡∏£‡∏∑‡∏≠ 0..9
      let isPlus = Math.random() < 0.5;

      let signed = isPlus ? mag : -mag;

      if (preventNegative && sum + signed < 0) {
        signed = mag; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å
      }
      sum += signed;
      value = signed;
    }

    currentSequence.push(value);
  }

  if (preventNegative && sum < 0) {
    // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î) ‡πÉ‡∏´‡πâ offset ‡∏Ç‡∏∂‡πâ‡∏ô
    const offset = -sum;
    currentSequence[currentSequence.length - 1] += offset;
    sum = 0;
    for (let v of currentSequence) sum += v;
  }

  currentAnswer = sum;
}

function showNextNumber() {
  if (!isRunning) return;

  if (currentIndexInSeq < currentSequence.length) {
    const n = currentSequence[currentIndexInSeq];
    displayBox.textContent = n.toString();
    playBeep(900, 0.08);

    if (mode === "challenge" && currentQuestionIndex === 1 && currentIndexInSeq === 0) {
      if (!challengeStartTime) {
        challengeStartTime = performance.now();
      }
    }

    currentIndexInSeq++;

    const showTime  = Math.max(100, Math.min(5000, speedMs));
    const blankTime = Math.min(500, Math.floor(showTime / 2));

    mainTimer = setTimeout(() => {
      if (!isRunning) return;
      displayBox.textContent = "";
      mainTimer = setTimeout(showNextNumber, blankTime);
    }, showTime);
  } else {
    if (mode === "practice") {
      startPracticeAnswerPhase();
    } else {
      startChallengeAnswerPhase();
    }
  }
}

// ‡πÇ‡∏´‡∏°‡∏î‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô
function startPracticeAnswerPhase() {
  if (!isRunning) return;

  let count = 0;
  const totalBlinks = 6; // 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  const interval = 1000;

  function blink() {
    if (!isRunning) return;
    displayBox.textContent = (count % 2 === 0) ? "‡∏ï‡∏≠‡∏ö" : "";
    if (count % 2 === 0) playBeep(1000, 0.08);
    count++;
    if (count < totalBlinks) {
      blinkTimer = setTimeout(blink, interval);
    } else {
      blinkTimer = setTimeout(() => {
        if (!isRunning) return;
        displayBox.textContent = currentAnswer.toString();
        playBeep(1200, 0.12);
        setMascotSpeech("‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠ " + currentAnswer + " ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ!");
        mainTimer = setTimeout(() => {
          if (!isRunning) return;
          if (currentQuestionIndex >= totalQuestions) {
            finishPracticeSession();
          } else {
            currentQuestionIndex++;
            startQuestion();
          }
        }, 2000);
      }, 1000);
    }
  }
  blink();
}

function finishPracticeSession() {
  isRunning = false;
  displayBox.textContent = `‡∏Ñ‡∏£‡∏ö ${totalQuestions} ‡∏Ç‡πâ‡∏≠`;
  setMascotSpeech("‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏î‡∏π‡πÑ‡∏´‡∏°?");

  if (currentUser) {
    const key = "practice_results_" + currentUser;
    let arr = [];
    try {
      const raw = localStorage.getItem(key);
      if (raw) {
        const tmp = JSON.parse(raw);
        if (Array.isArray(tmp)) arr = tmp;
      }
    } catch(e){}
    arr.push({
      date: new Date().toISOString(),
      numbersPerQuestion,
      totalQuestions,
      speedMs,
      opType,
      noZero,
      preventNegative
    });
    localStorage.setItem(key, JSON.stringify(arr));
  }
}

// ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢
function startChallengeAnswerPhase() {
  if (!isRunning) return;
  displayBox.textContent = "‡∏ï‡∏≠‡∏ö";
  playBeep(1000, 0.08);
  setMascotSpeech("‡∏•‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÑ‡∏ß ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏î‡∏π‡πÄ‡∏•‡∏¢!");
  answerInput.value = "";
}

function submitChallengeAnswer() {
  if (!isRunning || mode !== "challenge") return;
  const val = answerInput.value.trim();
  if (!val) return;

  const userAns = parseInt(val, 10);
  if (isNaN(userAns)) {
    answerInput.value = "";
    return;
  }

  if (userAns === currentAnswer) {
    challengeCorrect++;
    displayBox.textContent = "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!";
    playBeep(1200, 0.12);
    answerInput.value = "";
    setMascotSpeech("‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Å‡∏±‡∏ô!");

    if (challengeCorrect >= challengeTarget) {
      finishChallengeSession();
    } else {
      currentQuestionIndex++;
      mainTimer = setTimeout(() => {
        if (!isRunning) return;
        startQuestion();
      }, 700);
    }
  } else {
    challengeMistakes++;
    displayBox.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å";
    playBeep(500, 0.12);
    answerInput.value = "";
    setMascotSpeech("‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£ ‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏î‡∏π‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á!");

    mainTimer = setTimeout(() => {
      if (!isRunning) return;
      startQuestion(); // ‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà
    }, 700);
  }
}

function finishChallengeSession() {
  isRunning = false;
  const endTime = performance.now();
  let totalSec = 0;
  if (challengeStartTime != null) {
    totalSec = (endTime - challengeStartTime) / 1000;
  }
  displayBox.textContent = `‡∏à‡∏ö! ${totalSec.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;

  if (challengeMistakes === 0) {
    setMascotSpeech("‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡πÑ‡∏°‡πà‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏•‡∏¢‡∏™‡∏±‡∏Å‡∏Ç‡πâ‡∏≠!");
  } else {
    setMascotSpeech("‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏î‡∏π‡∏ô‡∏∞");
  }

  if (currentUser) {
    const key = "challenge_results_" + currentUser;
    let arr = [];
    try {
      const raw = localStorage.getItem(key);
      if (raw) {
        const tmp = JSON.parse(raw);
        if (Array.isArray(tmp)) arr = tmp;
      }
    } catch(e){}
    arr.push({
      date: new Date().toISOString(),
      time: totalSec,
      mistakes: challengeMistakes,
      target: challengeTarget,
      numbersPerQuestion,
      opType,
      noZero,
      preventNegative
    });
    localStorage.setItem(key, JSON.stringify(arr));
  }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏° / ‡∏´‡∏¢‡∏∏‡∏î / ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
function startGame() {
  if (!currentUser) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  saveSettings();
  if (isRunning) return;
  isRunning = true;

  currentQuestionIndex = 1;
  currentSequence = [];
  currentAnswer = 0;
  currentIndexInSeq = 0;
  clearTimers();

  challengeCorrect = 0;
  challengeMistakes = 0;
  challengeTarget = totalQuestions;
  challengeStartTime = null;

  displayBox.textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°!!";
  playBeep(800, 0.12);
  setMascotSpeech("‡∏à‡∏±‡∏ö‡∏ï‡∏≤‡∏î‡∏π‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏ô‡∏∞!");

  mainTimer = setTimeout(() => {
    if (!isRunning) return;
    displayBox.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°!!";
    playBeep(1000, 0.12);
    mainTimer = setTimeout(() => {
      if (!isRunning) return;
      startQuestion();
    }, 800);
  }, 800);
}

function startQuestion() {
  if (!isRunning) return;
  clearTimers();

  displayBox.textContent = `‡∏Ç‡πâ‡∏≠ ${currentQuestionIndex}`;
  playBeep(750, 0.08);

  generateSequence();

  mainTimer = setTimeout(() => {
    if (!isRunning) return;
    currentIndexInSeq = 0;
    showNextNumber();
  }, 700);
}

function stopGame() {
  isRunning = false;
  clearTimers();
}

function resetGame() {
  stopGame();
  currentSequence = [];
  currentAnswer = 0;
  currentIndexInSeq = 0;
  currentQuestionIndex = 0;
  challengeCorrect = 0;
  challengeMistakes = 0;
  challengeStartTime = null;
  displayBox.textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°";
  answerInput.value = "";
  setMascotSpeech("‡∏°‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡∏î‡∏π‡πÑ‡∏´‡∏°?");
}

function clearTimers() {
  if (mainTimer) {
    clearTimeout(mainTimer);
    mainTimer = null;
  }
  if (blinkTimer) {
    clearTimeout(blinkTimer);
    blinkTimer = null;
  }
}

// Fullscreen
function toggleFullscreen() {
  const docEl = document.documentElement;
  const isFS = !!(
    document.fullscreenElement ||
    document.webkitFullscreenElement ||
    document.mozFullScreenElement ||
    document.msFullscreenElement
  );

  if (!isFS) {
    if (docEl.requestFullscreen) docEl.requestFullscreen();
    else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen();
    else if (docEl.mozRequestFullScreen) docEl.mozRequestFullScreen();
    else if (docEl.msRequestFullscreen) docEl.msRequestFullscreen();
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
    else if (document.msExitFullscreen) document.msExitFullscreen();
  }
}

// Keypad & keyboard
function buildKeypad() {
  if (!keypadDiv) return;
  keypadDiv.innerHTML = "";
  const layout = [0,1,2,3,4,5,6,7,8,9];
  layout.forEach(n => {
    const btn = document.createElement("button");
    btn.textContent = n.toString();
    btn.addEventListener("click", () => {
      answerInput.value += n.toString();
    });
    keypadDiv.appendChild(btn);
  });
}

function handleKeyEnter() { submitChallengeAnswer(); }
function handleKeyBack() {
  answerInput.value = answerInput.value.slice(0, -1);
}
function handleKeyClear() {
  answerInput.value = "";
}

function handleGlobalKeydown(e) {
  if (!isRunning || mode !== "challenge") return;
  if (e.key >= "0" && e.key <= "9") {
    e.preventDefault();
    answerInput.value += e.key;
  } else if (e.key === "Backspace") {
    e.preventDefault();
    answerInput.value = answerInput.value.slice(0, -1);
  } else if (e.key === "Enter") {
    e.preventDefault();
    submitChallengeAnswer();
  }
}

// Initial setup
window.addEventListener("DOMContentLoaded", () => {
  loadUsers();
  const stored = localStorage.getItem(CURRENT_USER_KEY);
  if (stored && users.find(x => x.username === stored)) {
    currentUser = stored;
    loginOverlay.style.display = "none";
  } else {
    loginOverlay.style.display = "flex";
  }
  updateCurrentUserBox();

  loadSettings();
  buildKeypad();

  if (loginBtn) {
    loginBtn.addEventListener("click", tryLogin);
  }
  if (loginUserInput && loginPassInput) {
    const handler = (e) => {
      if (e.key === "Enter") tryLogin();
    };
    loginUserInput.addEventListener("keydown", handler);
    loginPassInput.addEventListener("keydown", handler);
  }

  if (btnSettings) {
    btnSettings.addEventListener("click", () => {
      if (!settingsPanel) return;
      const visible = settingsPanel.style.display !== "none";
      settingsPanel.style.display = visible ? "none" : "block";
    });
  }
  if (btnStart)  btnStart.addEventListener("click", startGame);
  if (btnStop)   btnStop.addEventListener("click", stopGame);
  if (btnReset)  btnReset.addEventListener("click", resetGame);
  if (btnFullscreen) btnFullscreen.addEventListener("click", toggleFullscreen);

  [
    setMode,
    setOpType,
    setNoZero,
    setPreventNegative,
    setCountPerQuestion,
    setTotalQuestions,
    setSpeed,
    setFontSize,
    setSound,
    setTheme
  ].forEach(el => {
    if (!el) return;
    const evt = el.type === "checkbox" ? "change" : "input";
    el.addEventListener(evt, saveSettings);
  });

  if (adminToggleBtn) {
    adminToggleBtn.addEventListener("click", () => {
      if (!isAdminMode) {
        if (askAdminPassword()) {
          isAdminMode = true;
          adminPanel.style.display = "block";
          renderUserList();
        }
      } else {
        isAdminMode = false;
        adminPanel.style.display = "none";
      }
    });
  }
  if (adminAddUserBtn) {
    adminAddUserBtn.addEventListener("click", addUserFromAdmin);
  }
  if (adminResetAllBtn) {
    adminResetAllBtn.addEventListener("click", resetAllStats);
  }

  if (keyEnter)  keyEnter.addEventListener("click", handleKeyEnter);
  if (keyDelete) keyDelete.addEventListener("click", handleKeyBack);
  if (keyClear)  keyClear.addEventListener("click", handleKeyClear);

  document.addEventListener("keydown", handleGlobalKeydown);

  displayBox.textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°";
  setMascotSpeech("‡∏°‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡∏î‡∏π‡πÑ‡∏´‡∏°?");
});
</script>

</body>
</html>
